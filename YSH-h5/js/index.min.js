var h5stop = false;
var aniDone = false;
var perAni = false;

var aniID=[];
var aniI=0
$(".clock>div").each(function (i) {
    // $(this)
    aniID.push($(this)) //DOM 对象
})
console.log(aniID)
var main = {
    init: function () {
        this.loadImage();
    },
    loadingLogo: function (a) {
        var e = $("#loading-shadow");
        //var c = -e.position().top;
        var c = 1;
        var b = this;
        var d = setInterval(function () {
            if(c>99){
                clearInterval(d);
                d = null;
                //$(".loadpage").hide();
                //$("#ani").show();
                // b.Orienter()
            }
            if (c < a) {
                c++;
                $(".loading-num").html(c + "%")
            }
        }, 60)
    },
    loadImage: function () {
        var e = ["duihua1.png","NO1.png","NO2NEI.png","NO5T.png","NO9.png","duihua2.png","NO10.png","NO3.png","NO5V.png","NO9NEI.png","begin.png","duihua3.png","NO11.png","NO3NEI.png","NO6.png","only.png","bg.jpg","duihua4.png","NO11NEI.png","NO4.png","NO6NEI.png","btn_again.png","hammer.png","NO11T.png","NO4NEI.png","NO7.png","p1.png","btn_ham.png","loading.png","NO1NEI.png","NO4T.png","NO7NEI.png","shupin.png","btn_pk.png","logo.png","NO1V.png","NO5.png","NO8.png","color_clock.png","mask.png","NO2.png","NO5NEI.png","NO8NEI.png"];
        var g = "http://192.168.0.3:8080/img/";
        var b = 0;
        var a = e.length;
        var c = 0;
        var d = this;

        function f(i) {
            var h = new Image();
            h.onload = function () {
                b++;
                c = (b / a) * 100;
                if (b == a) {
                    //d.music()
                    $(".loadpage").hide();
                    $("#begin").show();
                    d.Orienter()
                }
                d.loadingLogo(c)
            };
            h.src = i
        }

        e.forEach(function (h) {
            f(g + h)
        })
    },
    music: function () {
        var c = document.getElementById("music");
        //pgvSendClick({hottag: "a20170329upm.mobile.music"});
        c.src = "http://game.gtimg.cn/images/up/act/a20170329upm/music/music.mp3";
        c.play();
        document.addEventListener("WeixinJSBridgeReady", function () {
            if (typeof WeixinJSBridge == "object") {
                WeixinJSBridge.invoke("getNetworkType", {}, function (j) {
                    c.play()
                })
            }
        });
        var e = false, d = false;
        var g = 0;
        var b = 0;

        function i() {
            setInterval(function () {
                g++
            }, 1000)
        }

        var h = 0;
        var f = true;
        $(".music1").on("click", function () {
            if (f) {
                f = false;
                $(".music1").removeClass("rotate-in-center");
                c.pause()
            } else {
                f = true;
                $(".music1").addClass("rotate-in-center");
                c.play()
            }
        });
        var a = setInterval(function () {
            if (h5stop) {
                clearTimeout(l);
                l = null;
                return
            }
            if (perAni) {
                clearTimeout(l);
                l = null;
                return
            }
            var j = 0;
            if (c.currentTime > 0 && b == 0) {
                i();
                b = 1
            }
            if (f) {
                h = c.currentTime | 0
            } else {
                h = g
            }
            switch (h) {
                case 1:
                    if (!e) {
                        //var k = $(".img1").offset().top + $(".img1").height() * 0.17;
                        var k = 30;
                        $(".img .progress").css({"top": k + "px"});
                        var l = setInterval(function () {
                            e = true;
                            j++;
                            $("#pageOnePer").text(j + "%");
                            if (j == 60) {
                                clearInterval(l)
                            }
                        }, 15);
                        $("#pageOneBar").find("i").animate({width: "60%"}, 1000)
                    }
                    break;
                case 2:
                    $("#section1").find(".t1").addClass("show");
                    break;
                case 4:
                    $("#section1").find(".t2").siblings("p").removeClass("show");
                    setTimeout(function () {
                        $("#section1").find(".t2").addClass("show")
                    }, 2000);
                    break;
                case 11:
                    $("#section1").find(".t-nai").addClass("bounceIn");
                    setTimeout(function () {
                        $("#section1").find(".t-xin").addClass("bounceIn")
                    }, 500);
                    break;
                case 13:
                    //$.fn.fullpage.moveTo(2);
                    break;
                case 28:
                    //$.fn.fullpage.moveTo(3);
                    break;
                case 40:
                   // $.fn.fullpage.moveTo(4);
                    break;
                case 59:
                   // $.fn.fullpage.moveTo(5);
                    c.src = "http://game.gtimg.cn/images/up/act/a20170329upm/music/play.mp3";
                    c.play();
                    perAni = true;
                    break;
                default:
            }
        }, 50)
    },
    start: 0,
    Orienter: function () {
        var g = this;
        var h = new Orienter();
        var a;
        var d = 0;
        var f = 0;
        var b = 0;
        var c = 4;

        function e(j) {
            var i = setInterval(function () {
                if (c > 0) {
                    c = c - 1;
                    $(".begin").html(c)
                }
                if (c <= 0) {
                    clearInterval(i)
                }
            }, 1000)
        }

        h.onOrient = function (i) {
            if (i.lat > -20 && i.lat < 20 && g.start == 0) {
                if (g.start == 0 && f == 0) {
                    //alert('开始')
                    f = 1;
                    $("#shupin").hide();
                    $("#begin").show();
                    e();
                    a = setTimeout(function () {;
                        $("#begin").hide();
                        Timer.Timer.toggle();
                        g.start = 1;
                        $("#ani").show();
                        //aniJS = aniDiv[0]
                        aniID[aniI].css("opacity","1")
                        aniID[aniI].addClass("mask_ani")
                        aniID[aniI][0].addEventListener("webkitAnimationEnd",aniStart);
                        //aniDiv.addEventListener("animationend", aniComplete(aniDiv));
                    }, 3800)
                }
            }
            if ((i.lat < -20 && g.start == 0) || (i.lat > 20 && g.start == 0)) {
                //$("#ani").hide();
                $("#begin").hide();
                $("#shupin").show();
                Timer.resetStopwatch();
                if (f == 1) {
                    f = 0
                }
                c = 4;
                $(".countdown").html(3);
                clearTimeout(a)
            }
            if ((i.lat < -20 && g.start == 1) || (i.lat > 20 && g.start == 1)) {
                if (d == 0 && aniDone != true) {
                    $(".clock>div").each(function (i) {
                        var adDiv=$(this)
                        adDiv[0].removeEventListener("animationend", aniStart);
                    })
                    //aniID[aniI][0].removeEventListener("webkitAnimationEnd", aniStart);
                    aniID[aniI][0].removeEventListener("animationend", aniStart);
                    $("#endpage").addClass("anima");
                    $(".clock>div").removeClass("mask_ani");
                    $(".clock>div").css("opacity","0";
                    $(".clock>div").removeClass("text_ani");
                    $("#ani").hide();
                    $(".endtime").html($(".count").clone().html());
                    Timer.resetStopwatch();
                    d = 1;
                }
            }
        };
        h.init();
        $(".btn_again").on("click", function () {
            g.start = 0;
            f = 0;
            d = 0;
            $(".countdown").html(3);
            $("#endpage").removeClass("anima");
            $("#shupin").show();
            h.Orienter();
        });
        $("#saveBtn").on("click", function () {
            $("#imgPop").show();
            var k = $("#imgResult").data("name");
            var j = $("#imgPop img");
            if (j && j.data("name") == k) {
                $("#imgPop").show()
            } else {
                var i = new Image();
                i.onload = function () {
                    $("#imgPop .tip").hide();
                    $("#imgPop").append($(i)).append('<p class="save-tip">长按图片<br />可保存到手机</p>');
                    $(i).data("name", k)
                };
                i.src = "http://game.gtimg.cn/images/up/act/a20170329upm/img/" + k + "-tree.jpg"
            }
        });
        $("#imgPop .close").on("click", function () {
            $("#imgPop").hide()
        })
    },
    landscape: function () {
        function a() {
            var i = localStorage;
            var f = i.getItem("J-recordOrientX");
            var b = document.documentElement.clientWidth, d = document.documentElement.clientHeight;
            var e = 0, c = 0;
            if (!f) {
                e = window.screen.width;
                c = window.screen.height;
                i.setItem("J-recordOrientX", e + "," + c)
            } else {
                var g = f.split(",");
                e = g[0];
                c = g[1]
            }
            if (b == e) {
                $("#Shine_landscape").hide();
                return
            }
            if (b == c) {
                $("#Shine_landscape").show();
                return
            }
        }
        a();
        window.addEventListener("resize", a)
    },
};
main.init();
var Timer = new (function () {
    var e, c = 70, b = 0, a = function () {
        e.html(formatTime(b));
        b += c / 10
    }, d = function () {
        e = $(".count");
        Timer.Timer = $.timer(a, c, true)
    };
    this.resetStopwatch = function () {
        b = 0;
        this.Timer.stop().once()
    };
    $(d)
});
function pad(b, a) {
    var c = "" + b;
    while (c.length < a) {
        c = "0" + c
    }
    return c
}
function formatTime(d) {
    var b = parseInt(d / 6000), c = parseInt(d / 100) - (b * 60), a = pad(d - (c * 100) - (b * 6000), 2);
    return (b > 0 ? pad(b, 2) : "00") + ":" + pad(c, 2) + ":" + a
}
function resize() {
    setTimeout(function () {
        if ($(window).height() > $(window).width()) {
            $("html").css("font-size", $("body").width() / 640 * 100 + "px")
        } else {
            $("html").css("font-size", $("body").height() / 1136 * 100 + "px")
        }
        $(".wrap").css("opacity", 1)
    }, 50)
}



function aniStart(){
    if(aniI<aniID.length){
        aniI+=1;
        console.log(aniI)
        if(aniI==37){
            $(".duihua>div").addClass("anima");
            setTimeout(function () {
                $(".duihua").hide(500);
                $(".knock>div").addClass("anima");
            },4000)
            return;
        }
        aniID[aniI].css("opacity","1")
        if(aniI==2 || aniI==5 || aniI==8 || aniI==12 || aniI==17 || aniI==20 || aniI==23 || aniI==26 || aniI==29 || aniI==31 || aniI==36){
            aniID[aniI].addClass("text_ani")
            setTimeout(function () {
                aniID[aniI].css("opacity","0")
            },1000)
        }else{
            aniID[aniI].addClass("mask_ani")
        }
        aniID[aniI][0].addEventListener("webkitAnimationEnd",aniStart);
    }
}
function aniComplete() {
    
}
window.onload = function () {
    resize()
};

$(".btn_ham").click(function () {
    $(".color_clock").show();
    setTimeout(function () {
        $(".btn_ham").hide();
        $(".hammer").hide();
    },1000)
    var b=0,
        $color_clock=$(".color_clock"),
        d=setInterval(function(){
            if(b>parseInt($color_clock.width()+150)){
                clearInterval(d);
                $(".clock").hide();
                $color_clock.animate({
                    left: "1.72rem",
                    top: "1.07rem",
                    width: "3.05rem",
                    height: "4.76rem",
            }, 2000,function () {
                    $(".result").addClass("on");
                })
            }
            $color_clock.css({"-webkit-mask":"-webkit-gradient(radial,100 0,"+b+",100 0, "+(b+1)+", from(rgba(255, 255, 255,1)), color-stop(0.5,rgba(255, 255, 255, 1)), to(rgba(255, 255, 255,0)))"});
            b++;
        },10);
})